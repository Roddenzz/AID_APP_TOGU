# Курсовая документация TOGU Aid App (расширенная)

Документ описывает цели, архитектуру, функциональность, сценарии работы, инфраструктуру Firebase, уведомления, безопасность, тестирование и эксплуатацию учебного приложения TOGU Aid App. Текст увеличен и детализирован для полноценного понимания курсового проекта.

---

## 1. Назначение и цели проекта
- **Цель**: показать, как цифровизировать взаимодействие студентов и профбюро: оперативный чат, подача заявлений на материальную помощь, уведомления, новости и аналитика.
- **Формат**: кроссплатформенный клиент на Flutter (Android, Windows), backend как сервис — Firebase (Firestore, Messaging).
- **Результат**: готовый учебный пример с понятной архитектурой, сценариями и кодом, который можно расширять под реальные процессы.

### Задачи
1) Обеспечить двухсторонний чат (студент ↔ сотрудники) с сохранением истории.  
2) Дать студенту возможность подать заявление с вложениями и подписью.  
3) Покрыть уведомлениями все важные события (новое сообщение, новое заявление, решение по заявлению).  
4) Показать структуру данных в Firestore и базовые правила безопасности (на уровне концепции).  
5) Реализовать UI с акцентом на простоту и понятность для обеих ролей.  
6) Сформировать понятные инструкции по сборке, развёртыванию и диагностике.

---

## 2. Роли и пользовательские сценарии
### Роли
- **Студент**: регистрируется, подаёт заявления, читает новости/FAQ, общается с сотрудниками, получает решения по своим заявлениям.
- **Сотрудник**: получает входящие заявления и сообщения студентов, отвечает в чат, принимает решения по заявлениям, публикует новости (концептуально).

### Основные сценарии
1) **Регистрация/логин**: студент или сотрудник вводит данные, сохраняется сессия, регистрируется FCM-токен для уведомлений.  
2) **Чат**:  
   - Студент пишет в общий канал → уведомление получают все сотрудники.  
   - Сотрудник отвечает конкретному студенту → уведомление получает только этот студент.  
   - История сообщений сохраняется и видна при открытии диалога.  
3) **Заявление**: студент заполняет форму, прикладывает файлы, ставит подпись → сотрудники получают уведомление и видят заявку в списке.  
4) **Решение по заявлению**: сотрудник утверждает/отклоняет → студент получает уведомление и видит статус в разделе «Мои заявления».  
5) **Новости и FAQ**: студент просматривает новости/лайкает, читает ответы на часто задаваемые вопросы.  
6) **Аналитика**: сводная информация по статусам заявлений (демонстрационный функционал).

---

## 3. Функциональность (подробно)
### Аутентификация и сессия
- Локальное хранение идентификатора пользователя в `SharedPreferences`.
- Восстановление сессии при старте, автоматический запуск слушателей уведомлений и загрузка токена FCM.
- Простейшая проверка пароля (учебный вариант; для боевого применения необходим Firebase Auth или собственная авторизация с хешированием).

### Чат
- Конверсация построена вокруг `conversationId`, равного `studentId`.
- Отправка, кеширование и сортировка сообщений по дате отправки.
- Для сотрудников: список диалогов с последним сообщением (обновляется в реальном времени через Firestore).
- Для студентов: персональный поток сообщений с сотрудниками.
- Уведомления и пуши завязаны на отправку сообщения.

### Заявления
- Форма с выбором категории, описанием, телефона, вложений, подписи.
- Отправка в Firestore и рассылка уведомлений сотрудникам.
- Обновление статусов: `pending`, `approved`, `rejected`, `inReview`.
- Список «Мои заявления» автоматически обновляется после отправки и при смене пользователя.

### Новости/FAQ/Аналитика
- Новости: просмотр, лайки (концептуально).
- FAQ: статические данные в коде.
- Аналитика: подсчёт количества заявлений по статусам, суммы по одобренным (демо).

### Уведомления
- Локальные (flutter_local_notifications) для всех поддерживаемых платформ.
- Пуши через FCM: серверный ключ (legacy) + токены пользователей; отправка при событиях чата и заявлений.
- Слушатели Firestore: `notifications` + подстраховка на новые сообщения (`messages` с recipientId = текущий пользователь).
- Работа в разных состояниях приложения: foreground (локальные), background/terminated (серверные пуши при условии валидного ключа и токена).

---

## 4. Техническая архитектура
### Слои
- **UI** (`lib/screens`, `lib/widgets`): экраны ролей, навигация, виджеты.
- **Сервисы** (`lib/services`): бизнес-логика, интеграция с Firestore/FCM, уведомления, хранилище сессии.
- **Модели** (`lib/models`): структуры данных с `fromMap/toMap`.
- **Утилиты** (`lib/utils`): темы, цвета, константы, валидация.

### Основные классы
- `AuthService`: сессия, роль пользователя, регистрация токенов, слушатели уведомлений.
- `DatabaseService`: CRUD для коллекций Firestore, нормализация данных, токены FCM.
- `ChatService`: стримы сообщений, сводки диалогов, уведомления и пуши для чатов.
- `ApplicationService`: создание/обновление заявлений, уведомления и пуши по статусам.
- `NotificationService`: локальные уведомления, каналы Android, обработка FCM, отправка пушей по токенам, слушатели Firestore.
- `AppShell`: общий каркас UI (desktop/mobile), навигация, шапка, боковая панель, bottom-nav.

### Данные и коллекции Firestore
- `users` — профили + `fcmTokens`.
- `staff_users` — быстрый реестр сотрудников.
- `messages` — сообщения, `conversationId` = `studentId`.
- `applications` — заявления со статусами и вложениями.
- `news` — новости.
- `notifications` — задания на доставку уведомлений (recipientId, payload).

### Потоки данных
1) **Чат**: пользователь отправляет → `messages` → уведомление + push → другой пользователь получает локальный пуш / читает стрим.
2) **Заявление**: студент отправляет → `applications` → push сотрудникам → сотрудник меняет статус → push студенту.
3) **Пуши**: событие → поиск токенов → HTTP FCM → системное уведомление (background/terminated) + локальное (foreground).

---

## 5. Требования к окружению и сборке
### Среда разработки
- Flutter SDK 3.x
- Android Studio (SDK, NDK, build-tools) / Xcode / Visual Studio (для Windows).
- Аккаунт Firebase, настроенные Firestore и FCM, подключенные Google-сервисы к приложению.

### Сборка
```bash
flutter pub get
flutter run                      # debug
flutter build apk --release      # Android APK
flutter build appbundle --release# Android AAB
flutter build windows --release  # Windows
```
Перед релизом на Android рекомендуется настроить собственный keystore и подписать сборку.

### Развёртывание
- Android: доставка APK/AAB (Play Store или прямое распространение).
- Windows: итоговый `build/windows/x64/runner/Release/` (exe + dll), можно упаковать в ZIP или собрать инсталлятор (Inno Setup/NSIS).

---

## 6. Подробная логика уведомлений
### Регистрация токенов
- При логине/восстановлении сессии AuthService запрашивает FCM-токен (Android/iOS) и сохраняет в `users.fcmTokens`. При onTokenRefresh — обновляет список.
- Для Windows токен не регистрируется (но локальные уведомления работают).

### Локальные уведомления
- Инициализация каналов, показ уведомлений в foreground.
- Слушатель Firestore `notifications` → локальный пуш → пометка доставленного.
- Подстраховка: слушатель `messages` для прямых сообщений текущему пользователю.

### Серверные пуши (background/terminated)
- Отправка через FCM HTTP (legacy): список токенов, high priority, channel_id, click_action.
- Требуется актуальный ключ FCM (в `NotificationService._fcmLegacyServerKey`), разрешения на уведомления и рабочее подключение к сети.

### Маршрутизация по событиям
- Сообщения: студент → всем сотрудникам; сотрудник → конкретному студенту.
- Заявления: отправка студентом → всем сотрудникам; решение сотрудника → студенту.

### Возможные причины, если пуш не приходит
- У пользователя нет `fcmTokens` (не залогинен или токен не получен).
- Ключ FCM неверный/ограничен, запрос FCM возвращает ошибку (смотреть логи).
- Канал уведомлений отключён в настройках устройства.
- Ограничения энергосбережения ОС блокируют доставку (зависит от прошивки).

---

## 7. Экранные модули (подробно)
### Студент
- **Dashboard**: навигация по разделам.
- **Чат**: списки сообщений, отправка в общий канал; уведомления сотрудникам.
- **Мои заявления**: форма подачи с вложениями и подписью; список отправленных заявлений со статусами.
- **Новости**: просмотр, лайки.
- **FAQ**: ответы на частые вопросы.

### Сотрудник
- **Dashboard**: панель навигации.
- **Чат**: список диалогов (по студентам) с последним сообщением и датой, быстрый переход в переписку.
- **Заявления**: просмотр входящих, смена статусов, уведомления студентам.
- **Новости/Статистика**: сводные данные, публикации (концептуально).

---

## 8. Безопасность и ограничения
- Нужны Firestore Security Rules: ограничить доступ к документам по userId/роль.
- Пароли в демо хранятся открыто — для продакшена обязательно использовать Firebase Auth/хеширование.
- Вложения и подписи хранятся в Firestore в base64 (учебный пример); для продакшена — перенести в Firebase Storage.
- Ключ FCM должен храниться вне клиента (бэкенд/Cloud Function); в учебных целях помещён в код.

---

## 9. Производительность и надёжность
- Чат и списки используют потоковые запросы Firestore; при ошибках применяются кеши (чтобы UI не пустел).
- Конвертации Timestamp → DateTime — безопасные методы `_safeDate`.
- Пуши отправляются пакетно по токенам; можно оптимизировать на стороне сервера/Cloud Function.
- Для больших объёмов: добавить пагинацию сообщений и заявлений, ограничить размер вложений.

---

## 10. Тестирование и диагностика
- Статический анализ: `flutter analyze`.
- Форматирование: `dart format lib`.
- Ручное тестирование: отправка сообщений, подача заявлений, смена статусов, проверка уведомлений (foreground/background/terminated).
- Проверка токенов: в Firestore коллекция `users` должна содержать массив `fcmTokens`.
- Диагностика пушей: смотреть логи `flutter run -d <android>` при отправке; при ошибках FCM выводятся HTTP-коды.
- По необходимости добавить widget/e2e-тесты в `test/` и `integration_test/`.

---

## 11. Развёртывание, DevOps, CI/CD (рекомендации)
- Настроить CI для сборок Android/Windows, прогонов analyze/format/test.
- Хранить ключи и конфиги в секретах CI, не в репозитории.
- Для пушей в проде: вынести отправку в Cloud Function (HTTP v1) или собственный сервер, исключить ключ из клиента.
- Логи и мониторинг: подключить Crashlytics/Logging для продакшена (в учебном проекте не включено).

---

## 12. Дорожная карта улучшений
1) Перевести авторизацию на Firebase Auth, хешировать пароли.  
2) Вынести вложения в Firebase Storage, добавить предпросмотр.  
3) Cloud Functions для отправки пушей (HTTP v1), убрать ключ из клиента.  
4) Права и роли: правила Firestore по ролям/ID, валидация входных данных.  
5) Улучшения UI: индикаторы прочтения, блокировка спама, поиск по сообщениям, фильтры заявлений.  
6) Локализация ARB (ru/en), e2e-тесты, мок-данные для демо.  
7) Инсталляторы: сборка MSI/NSIS/DMG при необходимости.  

---

## 13. Справочник команд
- Завод зависимостей: `flutter pub get`
- Запуск: `flutter run`
- Анализ: `flutter analyze`
- Форматирование: `dart format lib`
- Сборка APK: `flutter build apk --release`
- Сборка AAB: `flutter build appbundle --release`
- Сборка Windows: `flutter build windows --release`

---

## 14. Термины
- **ConversationId** — идентификатор диалога, всегда `studentId`.
- **FCM Token** — токен устройства для push-уведомлений.
- **Legacy server key** — ключ FCM для HTTP (старое API).
- **Foreground/Background/Terminated** — состояния приложения, влияющие на доставку уведомлений.

---

## 15. Итоги
TOGU Aid App демонстрирует связку Flutter + Firebase для решения прикладной задачи профбюро: чат, заявления, уведомления, аналитика. Архитектура и код организованы так, чтобы их можно было расширять: добавить строгие правила безопасности, полноценную авторизацию, вынести отправку пушей на сервер и масштабировать хранение. Данный документ описывает все ключевые аспекты, чтобы упростить защиту курсовой и дальнейшее развитие проекта.
